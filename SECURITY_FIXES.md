# Security Fixes Implementation

## Overview
This document describes the security vulnerabilities that were fixed and how to configure the new security features.

## Fixed Vulnerabilities

### 1. Rate Limiting ✅
**Issue:** No granular rate limits, API could break under load

**Solution:**
- Implemented granular rate limiters based on operation type:
  - **Read operations (GET)**: 100 requests per minute
  - **Write operations (POST, PUT, PATCH)**: 30 requests per minute
  - **Delete operations (DELETE)**: 10 requests per minute
  - **Auth operations**: 5 requests per 15 minutes (unchanged)
- Added graceful error handling - rate limit errors return proper JSON responses (429 status) without breaking the API
- Rate limit info included in response headers (`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`)

**Files Modified:**
- `backend/src/middleware/rateLimiter.ts` - Added granular limiters
- All route files - Applied appropriate limiters to each endpoint

### 2. Authentication ✅
**Issue:** Missing authentication on sensitive endpoints, no API secret token

**Solution:**
- **Protected `/api/auth/refresh`**: Added rate limiting (refresh token already validated in service)
- **Protected `/api/auth/logout`**: Now requires authentication token
- **Added API Secret Token validation**: 
  - New `API_SECRET` environment variable (32+ characters)
  - Middleware validates `X-API-Secret` header for all write/delete operations
  - Optional - if not set, validation is skipped (for backward compatibility)

**Files Modified:**
- `backend/src/middleware/auth.ts` - Added `validateApiSecret` middleware
- `backend/src/auth/auth.routes.ts` - Protected refresh/logout endpoints
- `backend/src/auth/auth.service.ts` - Added `logoutAll` method
- `backend/src/config/env.ts` - Added `API_SECRET` to schema
- All route files - Applied API secret validation to write/delete operations

### 3. CORS Configuration ✅
**Issue:** Generic CORS config, no origin validation, single origin only

**Solution:**
- **Custom CORS middleware** with strict origin validation
- **Multiple origin support**: `FRONTEND_URL` now accepts comma-separated URLs
  - Example: `https://app1.com,https://app2.com,http://localhost:5173`
- **Strict validation**: Only requests from allowed origins are accepted
- **Proper CORS headers**:
  - `Access-Control-Allow-Origin`: Validated origin only (not `*`)
  - `Access-Control-Allow-Methods`: Only required methods (GET, POST, PUT, DELETE, PATCH, OPTIONS)
  - `Access-Control-Allow-Headers`: Only required headers (Content-Type, Authorization, X-API-Secret)
  - `Access-Control-Allow-Credentials`: true
  - `Access-Control-Max-Age`: 86400 (24 hours for preflight cache)

**Files Modified:**
- `backend/src/middleware/cors.ts` - New custom CORS middleware
- `backend/src/config/env.ts` - Updated `FRONTEND_URL` to support arrays
- `backend/src/app.ts` - Replaced simple CORS with custom middleware
- `backend/src/server.ts` - Updated logging for multiple URLs

## Environment Variables

### Required (Backend)
- `DATABASE_URL` - PostgreSQL connection string (auto-set by Render)
- `JWT_SECRET` - Secret for access tokens (32+ chars, auto-generated)
- `JWT_REFRESH_SECRET` - Secret for refresh tokens (32+ chars, auto-generated)
- `FRONTEND_URL` - Single URL or comma-separated list (e.g., `https://app1.com,https://app2.com`)
- `NODE_ENV` - Environment (production/development/test)
- `PORT` - Server port (default: 3000)

### Optional (Backend)
- `API_SECRET` - Secret token for API validation (32+ chars, auto-generated in Render)
  - If not set, API secret validation is skipped
  - If set, all write/delete operations require `X-API-Secret` header
- `ENCRYPTION_KEY` - Key for vault encryption (32+ chars, auto-generated)

## Configuration for Render

### Backend Service Environment Variables

1. **FRONTEND_URL**: 
   - Single origin: `https://finance-tracker-frontend-rf1n.onrender.com`
   - Multiple origins: `https://finance-tracker-frontend-rf1n.onrender.com,https://staging.example.com,http://localhost:5173`
   - **Important**: No trailing slashes

2. **API_SECRET** (Optional but recommended):
   - Auto-generated by Render (32+ characters)
   - If set, frontend must include `X-API-Secret` header in all POST/PUT/DELETE requests
   - If not set, API secret validation is skipped

### Frontend Configuration

If `API_SECRET` is set, the frontend needs to include it in write/delete requests:

```typescript
// In API service (src/services/api.ts)
const API_SECRET = import.meta.env.VITE_API_SECRET;

// Add to headers for write/delete operations
headers['X-API-Secret'] = API_SECRET;
```

**Note**: For now, API_SECRET validation is optional. If you want to enable it:
1. Set `API_SECRET` in backend environment variables
2. Set `VITE_API_SECRET` in frontend environment variables
3. Update frontend API service to include the header

## Rate Limit Response

When rate limit is exceeded, the API returns:

```json
{
  "success": false,
  "error": "Too many requests, please try again later.",
  "retryAfter": "60"
}
```

Status: `429 Too Many Requests`

Response headers include:
- `X-RateLimit-Limit`: Maximum requests allowed
- `X-RateLimit-Remaining`: Requests remaining in current window
- `X-RateLimit-Reset`: Time when limit resets (Unix timestamp)
- `Retry-After`: Seconds to wait before retrying

## CORS Error Response

When origin is not allowed:

```json
{
  "success": false,
  "error": "Origin not allowed"
}
```

Status: `403 Forbidden`

## API Secret Error Response

When API secret is missing or invalid:

```json
{
  "success": false,
  "error": "API secret token required"
}
```

or

```json
{
  "success": false,
  "error": "Invalid API secret token"
}
```

Status: `401 Unauthorized`

## Testing

### Test Rate Limiting
```bash
# Make 101 GET requests quickly
for i in {1..101}; do curl http://localhost:3000/api/accounts; done
# Should get 429 after 100 requests
```

### Test CORS
```bash
# Request from unauthorized origin
curl -H "Origin: https://evil.com" http://localhost:3000/api/accounts
# Should get 403 Forbidden
```

### Test API Secret
```bash
# POST request without API secret (if API_SECRET is set)
curl -X POST http://localhost:3000/api/accounts \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"name":"Test"}'
# Should get 401 if API_SECRET is set
```

## Migration Notes

1. **FRONTEND_URL**: Can now accept multiple URLs separated by commas
2. **API_SECRET**: Optional - existing deployments will continue to work without it
3. **Rate Limits**: More restrictive than before - monitor for legitimate rate limit hits
4. **Logout**: Now requires authentication - frontend should send auth token

## Security Improvements Summary

✅ **Rate Limits**: Prevents abuse, graceful error handling, won't break API
✅ **Authentication**: All sensitive endpoints protected, API secret adds extra layer
✅ **CORS**: Multi-origin support with strict validation, proper headers

